<!DOCTYPE html>
<html>

<head>
  <title>User Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <!-- reset browser styles -->
  <!-- <link rel="assets/stylesheet" type="text/css" media="screen" href="styles/reset.css" /> -->
  <link rel="stylesheet" type="text/css" media="screen" href="CSS/googleplaces2.css" />


  <!-- bootstrap links -->
  <!-- Latest compiled and minified CSS -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
  <!-- Optional theme -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> -->
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js"></script>
  
  <!-- Modernizr -->
  <script src="../js/libs/modernizr-2.6.2.min.js"></script>
  <!-- jQuery-->
  <script type="text/javascript" src="../js/libs/jquery-1.10.2.min.js"></script>
  <!--FireBase-->
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
  
  <script>
    var map;
    var infoWindow;
    var service;
    var curLocation = {
      lat: 39.9520323,
      lng: -75.1641467
    };
    var curMap = 'library'
    var markersList = [];

    function whereAmI() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(pos);
          curLocation = pos;
          // console.log(pos)
        }, function () {
          handleLocationError(true);
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false);
      }
    }

    function handleLocationError(browserHasGeolocation) {
      var msg = (browserHasGeolocation ? 
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
      console.log(msg)
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: curLocation,
        zoom: 14,
        styles: [{
          stylers: [{
            visibility: 'simplified'
          }]
        }, {
          elementType: 'labels',
          stylers: [{
            visibility: 'off'
          }]
        }],
        mapTypeControl: false
      });

      infoWindow = new google.maps.InfoWindow();
      service = new google.maps.places.PlacesService(map);

      // The idle event is a debounced event, so we can query & listen without
      // throwing too many requests at the server.
      map.addListener('idle', performSearch);
      map.addListener('bounds_changed', boundsChanged)
    }

    function boundsChanged() {
      console.log("bounds changed.")
      console.log("new center "+map.getCenter())
      console.log("cur location is "+curLocation)
      curLocation = map.getCenter();
      console.log("updated cur location is "+curLocation)
    }

    function performSearch() {
      var request = {
        bounds: map.getBounds(),
        keyword: curMap
      };
      // var request = {location: curLocation,radius: 1000,keyword: 'book store'};
      service.nearbySearch(request, callback);
    }

    function callback(results, status) {
      if (status !== google.maps.places.PlacesServiceStatus.OK) {
        console.error(status);
        return;
      }
      for (var i = 0, result; result = results[i]; i++) {
        // console.log(result);
        addMarker(result);
      }
    }

      function makeHoursHTML(anArray) {
        var returnHTML = '';
        var weekday = ["Sun", "Mon", "Tues", "Wed", "Thurs", "Fri", "Sat"]
        for (i = 0; i < anArray.length; i++) {
          var day = weekday[i];
          var opensAt = moment(anArray[i].open.time, "HHmm").format("hh:mm a");
          var closesAt = moment(anArray[i].close.time).format("hh:mm a");
          returnHTML += day + ": " + opensAt + " to " + closesAt + "<br>";
        }
        return returnHTML;
      }


    function addMarker(place) {
      var marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        icon: {
          url: 'https://developers.google.com/maps/documentation/javascript/images/circle.png',
          anchor: new google.maps.Point(10, 10),
          scaledSize: new google.maps.Size(10, 17)
        }
      });
      markersList.push(marker)

      // handle clicks on markers
      google.maps.event.addListener(marker, 'click', function () {
        var request = {
          placeId: place.place_id
        };

        service.getDetails(request, function (result, status) {
          if (status !== google.maps.places.PlacesServiceStatus.OK) {
            console.error(status);
            return;
          }
          
          try {
            var theHours = makeHoursHTML(result.opening_hours.periods);
          } catch (error) {
            console.log(error);
            var theHours = '';
          }
          try {
            var telNo = result.formatted_phone_number;
          } catch (error) {
            console.log(error);
            var telNo = '';
          }

          var bubbleHTML = "<b>"+result.name + "</b><br>" + result.website + "<br>" + result.formatted_address + "<br>" + telNo + "<br>" + theHours;
          infoWindow.setContent(bubbleHTML);
          infoWindow.open(map, marker);
        });
      });
    }

    function listPlaces() {
      console.log("in ListPlaces")
      console.log(markersList)
      for (i=0; i<markersList.length; i++) {
        
        console.log(i, markersList[i]);
      }
    }
  </script>
</head>

<body>
  <header class="padded">
      <div class="container">
        <div class="row">
          <div class="one half">
            <h2 class="logo"><a href="/" target="_parent"><img src="images/books logo.jpg" alt="Books for Everyone!!">Books for Everyone!!</a></h2>
          </div>
          <div class="one half">
          </div>
        </div>
        <nav role="navigation" class="nav gap-top">
          <ul role="menubar">
            <li><a href="./home.html"><i class="icon-home"></i> Home</a></li>
            <li role="menu">
              <button>Community</button>
              <ul>
                <li><a href="bookpage.html">BookList Page</a></li>
                <li><a href="wishlist.html">WishList Page</a></li>
                <li><a href="community.html">Community Page</a></li>
              </ul>
            </li>
            
              
        </nav>
      </div>
    </header>


  <div id="map-holder" class="map-size-m">
    <input type="button" id="btn-library" class="btn-active" name="btn-library" value="Libraries">
    <input type="button" id="btn-store" name="btn-store" value="Bookstores">
    <div id="map"></div>
    <div ="btn-size-holder">
      <!-- <span id="btn-size-label">Map Size:</span> -->
      <!-- <input type="button" id="btn-size-xs" class="btn-size" name="btn-size-xs" value="XS"> -->
      <input type="button" id="btn-size-s" class="btn-size" name="btn-size-s" value="S">
      <input type="button" id="btn-size-m" class="btn-size" name="btn-size-m" value="M">
      <input type="button" id="btn-size-l" class="btn-size" name="btn-size-l" value="L">
      <input type="button" id="btn-size-xl" class="btn-size" name="btn-size-xl" value="XL">
    </div>
  </div>

  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTrLjTdz7FcMXK268u0JLkR_KybHh8GJk&callback=initMap&libraries=places,visualization"></script>

  <script>
    whereAmI();
    initMap();
    // listPlaces();

    $("#btn-store").on("click", function () {
      $("#btn-store").addClass("btn-active");
      $("#btn-store").removeClass("btn-inactive");
      $("#btn-library").addClass("btn-inactive");
      $("#btn-library").removeClass("btn-active");
      if (curMap != 'book store') {
        curMap = 'book store';
        initMap();
      }
    })

    $("#btn-library").on("click", function() {
      $("#btn-library").addClass("btn-active");
      $("#btn-library").removeClass("btn-inactive");
      $("#btn-store").addClass("btn-inactive");
      $("#btn-store").removeClass("btn-active");
      if (curMap != 'library') {
        curMap = 'library';
        initMap();
      }
    })

  $("#btn-size-s").on("click", function() {
    $("#btn-size-s").addClass("btn-size-active");
    // $("#btn-size-s").removeClass("btn-size-active");
    $("#btn-size-m").removeClass("btn-size-active");
    $("#btn-size-l").removeClass("btn-size-active");
    $("#btn-size-xl").removeClass("btn-size-active");
    $("#map-holder").addClass("map-size-s");
    // $("#map-holder").removeClass("map-size-s");
    $("#map-holder").removeClass("map-size-m");
    $("#map-holder").removeClass("map-size-l");
    $("#map-holder").removeClass("map-size-xl");
  });
  $("#btn-size-m").on("click", function() {
    $("#btn-size-m").addClass("btn-size-active");
    $("#btn-size-s").removeClass("btn-size-active");
    // $("#btn-size-m").removeClass("btn-size-active");
    $("#btn-size-l").removeClass("btn-size-active");
    $("#btn-size-xl").removeClass("btn-size-active");
    $("#map-holder").addClass("map-size-m");
    $("#map-holder").removeClass("map-size-s");
    // $("#map-holder").removeClass("map-size-m");
    $("#map-holder").removeClass("map-size-l");
    $("#map-holder").removeClass("map-size-xl");
  });
  $("#btn-size-l").on("click", function() {
    $("#btn-size-l").addClass("btn-size-active");
    $("#btn-size-s").removeClass("btn-size-active");
    $("#btn-size-m").removeClass("btn-size-active");
    // $("#btn-size-l").removeClass("btn-size-active");
    $("#btn-size-xl").removeClass("btn-size-active");
    $("#map-holder").addClass("map-size-l");
    $("#map-holder").removeClass("map-size-s");
    $("#map-holder").removeClass("map-size-m");
    // $("#map-holder").removeClass("map-size-l");
    $("#map-holder").removeClass("map-size-xl");
  });
  $("#btn-size-xl").on("click", function() {
    $("#btn-size-xl").addClass("btn-size-active");
    $("#btn-size-s").removeClass("btn-size-active");
    $("#btn-size-m").removeClass("btn-size-active");
    $("#btn-size-l").removeClass("btn-size-active");
    // $("#btn-size-xl").removeClass("btn-size-active");
    $("#map-holder").addClass("map-size-xl");
    $("#map-holder").removeClass("map-size-s");
    $("#map-holder").removeClass("map-size-m");
    $("#map-holder").removeClass("map-size-l");
    // $("#map-holder").removeClass("map-size-xl");
  }); 


  $("#btn-size-s").removeClass("btn-size-active");
  $("#btn-size-m").removeClass("btn-size-active");
  $("#btn-size-l").removeClass("btn-size-active");
  $("#btn-size-xl").removeClass("btn-size-active");



</script>


</body>